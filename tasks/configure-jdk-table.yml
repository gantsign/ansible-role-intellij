---
- name: create IntelliJ IDEA user options directory
  become: yes
  file:
    dest: "~{{ item.username }}/{{ intellij_user_dir }}/config/options"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: 'ug=rwx,o=rx'
  with_items: "{{ users }}"

- name: query Java specification version
  command: "{{ intellij_default_jdk_home }}/bin/jrunscript -e \"print(java.lang.System.getProperty('java.specification.version'))\""
  register: java_specification_version_result
  changed_when: no

- name: load JDK vars
  include_vars: "../vars/jdk_version/{{ java_specification_version_result.stdout }}.yml"

- name: assert JDK vars
  assert:
    that:
      - "intellij_default_jdk_classpath not in (None, '')"
      - "intellij_default_language_level not in (None, '')"

- name: query Java version
  command: "{{ intellij_default_jdk_home }}/bin/jrunscript -e \"print(java.lang.System.getProperty('java.version'))\""
  register: java_version_result
  changed_when: no

- name: configure JDKs
  become: yes
  template:
    src: jdk.table.xml.j2
    dest: "~{{ item.username }}/{{ intellij_user_dir }}/config/options/jdk.table.xml"
    force: no
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: 'ug=rw,o=r'
  with_items: "{{ users }}"
